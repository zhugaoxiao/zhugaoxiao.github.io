<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="大自然的搬运工" />



  <meta name="keywords" content="keystone,openstack," />





  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="这周在折腾openstack，下面是过程小记。

参考：Chapter 3. Add the Identity service">
<meta property="og:type" content="article">
<meta property="og:title" content="openstack之kilo安装 认证服务">
<meta property="og:url" content="zhugaoxiao.github.io/2015/10/25/openstack-Identity-service/index.html">
<meta property="og:site_name" content="高校的小站">
<meta property="og:description" content="这周在折腾openstack，下面是过程小记。

参考：Chapter 3. Add the Identity service">
<meta property="og:updated_time" content="2015-11-05T13:15:41.826Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="openstack之kilo安装 认证服务">
<meta name="twitter:description" content="这周在折腾openstack，下面是过程小记。

参考：Chapter 3. Add the Identity service">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'hide'
  };
</script>

  <title> openstack之kilo安装 认证服务 | 高校的小站 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">高校的小站</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'C7zDme1dExGhEGz8vgSx','2.0.0');
</script>



    </div>
  
</nav>
 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              openstack之kilo安装 认证服务
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-10-25T00:00:00+08:00" content="2015-10-25">
            2015-10-25
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/openstack/" itemprop="url" rel="index">
                  <span itemprop="name">openstack</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/10/25/openstack-Identity-service/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/10/25/openstack-Identity-service/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        

        
        <span>&nbsp; | &nbsp;
        <span id="busuanzi_value_page_pv" ></span>次阅读
        </span>
        


      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>这周在折腾openstack，下面是过程小记。</p>
<blockquote>
<p>参考：<a href="http://docs.openstack.org/kilo/install-guide/install/yum/content/ch_keystone.html" target="_blank" rel="external">Chapter 3. Add the Identity service</a></p>
</blockquote>
<a id="more"></a>
<h1 id="Install_and_configure">Install and configure</h1><blockquote>
<p>[Note]    Note<br>In Kilo, the keystone project deprecates Eventlet in favor of a WSGI server. This guide uses the Apache HTTP server with mod_wsgi to serve keystone requests on ports 5000 and 35357. By default, the keystone service still listens on ports 5000 and 35357. Therefore, this guide disables the keystone service.</p>
</blockquote>
<p>在安装OpensStack认证服务前，需要先创建数据库和administration token。</p>
<p>创建数据库：<br><figure class="highlight oxygene"><table><tr><td class="code"><pre><span class="line">#</span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE keystone;</span><br><span class="line"></span><br><span class="line">GRANT ALL PRIVILEGES <span class="keyword">ON</span> keystone.* <span class="keyword">TO</span> <span class="string">'keystone'</span>@<span class="string">'localhost'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'KEYSTONE_DBPASS'</span>;</span><br><span class="line">GRANT ALL PRIVILEGES <span class="keyword">ON</span> keystone.* <span class="keyword">TO</span> <span class="string">'keystone'</span>@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'KEYSTONE_DBPASS'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span></span><br></pre></td></tr></table></figure></p>
<p>安装相关软件包：<br><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">yum <span class="keyword">install</span> -y openstack-keystone httpd mod_wsgi python-openstackclient memcached python-memcached</span><br></pre></td></tr></table></figure></p>
<p>启动并开机自启动:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">systemctl <span class="built_in">enable</span> memcached.service</span><br><span class="line">systemctl start memcached.service</span><br></pre></td></tr></table></figure></p>
<p>生成随机值用于后面作为token初始化：<br><figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openssl <span class="keyword">rand</span> -<span class="keyword">hex</span> <span class="number">10</span></span><br><span class="line">a4d418d94e2c380f614c</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注：上面的作用是生成随机字符串用于用户访问的即keystone.conf中的 admin_token ，也可以自己随意写，本次安装admin_token设置为ADMIN_TOKEN。</p>
</blockquote>
<p>编辑etc/keystone/keystone.conf文件：<br><figure class="highlight makefile"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">cp /etc/keystone/keystone.conf /etc/keystone/keystone.confbak</span><br><span class="line">echo "[DEFAULT]</span><br><span class="line"><span class="constant">verbose</span> = True</span><br><span class="line"><span class="constant">admin_token</span> = ADMIN_TOKEN</span><br><span class="line">[database]</span><br><span class="line"><span class="constant">connection</span> = mysql://keystone:KEYSTONE_DBPASS@controller/keystone</span><br><span class="line">[memcache]</span><br><span class="line"><span class="constant">servers</span> = localhost:11211</span><br><span class="line">[token]</span><br><span class="line"><span class="constant">provider</span> = keystone.token.providers.uuid.Provider</span><br><span class="line"><span class="constant">driver</span> = keystone.token.persistence.backends.memcache.Token</span><br><span class="line">[revoke]</span><br><span class="line"><span class="constant">driver</span> = keystone.contrib.revoke.backends.sql.Revoke" &gt;/etc/keystone/keystone.conf</span><br></pre></td></tr></table></figure></p>
<p>同步认证服务数据库:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">su <span class="operator">-s</span> /bin/sh -c <span class="string">"keystone-manage db_sync"</span> keystone</span><br></pre></td></tr></table></figure></p>
<p>配置 /etc/httpd/conf/httpd.conf 文件:<br><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">#</span><br><span class="line">cp -a <span class="regexp">/etc/</span>httpd<span class="regexp">/conf/</span>httpd.conf <span class="regexp">/etc/</span>httpd<span class="regexp">/conf/</span>httpd.conf_bak</span><br><span class="line"></span><br><span class="line">sed  -i  <span class="string">"s/#ServerName www.example.com:80/ServerName $&#123;HOSTNAME&#125;/"</span> <span class="regexp">/etc/</span>httpd<span class="regexp">/conf/</span>httpd.conf</span><br></pre></td></tr></table></figure></p>
<p>创建/etc/httpd/conf.d/wsgi-keystone.conf 文件:<br><figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">#</span><br><span class="line">echo "Listen 5000</span><br><span class="line">Listen 35357</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:5000&gt;</span><br><span class="line">    WSGIDaemonProcess keystone-public processes=5 threads=1 user=keystone group=keystone <span class="keyword">display</span>-name=%&#123;GROUP&#125;</span><br><span class="line">    WSGIProcessGroup keystone-public</span><br><span class="line">    WSGIScriptAlias / /<span class="keyword">var</span>/www/cgi-bin/keystone/main</span><br><span class="line">    WSGIApplicationGroup %&#123;<span class="keyword">GLOBAL</span>&#125;</span><br><span class="line">    WSGIPassAuthorization <span class="keyword">On</span></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLogFormat \<span class="string">"%&#123;cu&#125;t %M\"</span></span><br><span class="line">    ErrorLog /<span class="keyword">var</span>/<span class="keyword">log</span>/httpd/keystone-<span class="keyword">error</span>.<span class="literal">log</span></span><br><span class="line">    CustomLog /<span class="keyword">var</span>/<span class="keyword">log</span>/httpd/keystone-access.<span class="keyword">log</span> combined</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:35357&gt;</span><br><span class="line">    WSGIDaemonProcess keystone-admin processes=5 threads=1 user=keystone group=keystone <span class="keyword">display</span>-name=%&#123;GROUP&#125;</span><br><span class="line">    WSGIProcessGroup keystone-admin</span><br><span class="line">    WSGIScriptAlias / /<span class="keyword">var</span>/www/cgi-bin/keystone/admin</span><br><span class="line">    WSGIApplicationGroup %&#123;<span class="keyword">GLOBAL</span>&#125;</span><br><span class="line">    WSGIPassAuthorization <span class="keyword">On</span></span><br><span class="line">    LogLevel info</span><br><span class="line">    ErrorLogFormat \<span class="string">"%&#123;cu&#125;t %M\"</span></span><br><span class="line">    ErrorLog /<span class="keyword">var</span>/<span class="keyword">log</span>/httpd/keystone-<span class="keyword">error</span>.<span class="literal">log</span></span><br><span class="line">    CustomLog /<span class="keyword">var</span>/<span class="keyword">log</span>/httpd/keystone-access.<span class="keyword">log</span> combined</span><br><span class="line">&lt;/VirtualHost&gt;" &gt;/etc/httpd/<span class="keyword">conf</span>.<span class="keyword">d</span>/wsgi-keystone.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure></p>
<p>创建WSGI组件目录:<br><figure class="highlight vala"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">#</span></span><br><span class="line">mkdir -p /<span class="keyword">var</span>/www/cgi-bin/keystone</span><br></pre></td></tr></table></figure></p>
<p>复制WSGI组件到这个目录：<br><figure class="highlight cal"><table><tr><td class="code"><pre><span class="line"># curl http://git.openstack.org/cgit/openstack/keystone/plain/httpd/keystone.py?h=stable/kilo | tee /<span class="keyword">var</span>/www/cgi-bin/keystone/main /<span class="keyword">var</span>/www/cgi-bin/keystone/admin</span><br></pre></td></tr></table></figure></p>
<p>由于这个需要联网下载，我把内容直接贴过来了。<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"import os</span><br><span class="line">from keystone.server import wsgi as wsgi_server</span><br><span class="line">name = os.path.basename(__file__)</span><br><span class="line">application = wsgi_server.initialize_application(name)"</span> &gt;/<span class="keyword">var</span>/www/cgi-bin/keystone/main</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"import os</span><br><span class="line">from keystone.server import wsgi as wsgi_server</span><br><span class="line">name = os.path.basename(__file__)</span><br><span class="line">application = wsgi_server.initialize_application(name)"</span> &gt;/<span class="keyword">var</span>/www/cgi-bin/keystone/admin</span><br></pre></td></tr></table></figure></p>
<p>调整目录及目录内文件属组和权限:<br><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">#</span><br><span class="line">chown -R keystone:keystone <span class="regexp">/var/</span>www<span class="regexp">/cgi-bin/</span>keystone</span><br><span class="line">chmod <span class="number">755</span> <span class="regexp">/var/</span>www<span class="regexp">/cgi-bin/</span>keystone<span class="comment">/*</span></span><br></pre></td></tr></table></figure></p>
<p>重启 Apache HTTP server:<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">systemctl <span class="built_in">enable</span> httpd.service</span><br><span class="line">systemctl start httpd.service</span><br></pre></td></tr></table></figure></p>
<h1 id="Create_the_service_entity_and_API_endpoint">Create the service entity and API endpoint</h1><p>临时环境变量设置<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">#</span></span><br><span class="line"><span class="keyword">export</span> OS_TOKEN=ADMIN_TOKEN</span><br><span class="line"><span class="keyword">export</span> OS_URL=http:<span class="comment">//controller:35357/v2.0</span></span><br></pre></td></tr></table></figure></p>
<p>创建service entity for the Identity service：</p>
<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack service <span class="built_in">create</span> \</span><br><span class="line"> <span class="comment">--name keystone --description "OpenStack Identity" identity</span></span><br></pre></td></tr></table></figure>
<p>创建 Identity service API endpoint:</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><span class="line">#</span><br><span class="line">openstack endpoint create \</span><br><span class="line">  -<span class="ruby">-publicurl <span class="symbol">http:</span>/<span class="regexp">/controller:5000/v</span>2.<span class="number">0</span> \</span><br><span class="line"></span>  -<span class="ruby">-internalurl <span class="symbol">http:</span>/<span class="regexp">/controller:5000/v</span>2.<span class="number">0</span> \</span><br><span class="line"></span>  -<span class="ruby">-adminurl <span class="symbol">http:</span>/<span class="regexp">/controller:35357/v</span>2.<span class="number">0</span> \</span><br><span class="line"></span>  -<span class="ruby">-region <span class="constant">RegionOne</span> \</span><br><span class="line"></span>  identity</span><br></pre></td></tr></table></figure>
<h1 id="Create_projects,_users,_and_roles">Create projects, users, and roles</h1><p>The Identity service provides authentication services for each OpenStack service. The authentication service uses a combination of domains, projects (tenants), users, and roles.</p>
<p>创建 admin project:<br><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack <span class="keyword">project</span> create --description <span class="string">"Admin Project"</span> admin</span><br></pre></td></tr></table></figure></p>
<p>创建 admin user:<br><figure class="highlight nsis"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack <span class="literal">user</span> create  <span class="literal">admin</span> --password <span class="literal">admin</span></span><br></pre></td></tr></table></figure></p>
<p>创建 the admin role:<br><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack role <span class="built_in">create</span> admin</span><br></pre></td></tr></table></figure></p>
<p>添加admin role to the admin project and user:<br><figure class="highlight nsis"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack role add --project <span class="literal">admin</span> --<span class="literal">user</span> <span class="literal">admin</span> <span class="literal">admin</span></span><br></pre></td></tr></table></figure></p>
<p>This guide uses a service project that contains a unique user for each service that you add to your environment.</p>
<p>创建  service project:<br><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack <span class="keyword">project</span> create --description <span class="string">"Service Project"</span> service</span><br></pre></td></tr></table></figure></p>
<p>Regular (non-admin) tasks should use an unprivileged project and user. As an example, this guide creates the demo project and user.</p>
<p>创建 demo project:<br><figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack <span class="keyword">project</span> create --description <span class="string">"Demo Project"</span> demo</span><br></pre></td></tr></table></figure></p>
<p>创建 demo user:<br><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack user <span class="built_in">create</span> demo <span class="comment">--password demo</span></span><br></pre></td></tr></table></figure></p>
<p>创建 user role:<br><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack role create <span class="built_ins">user</span></span><br></pre></td></tr></table></figure></p>
<p>Add the user role to the demo project and user:<br><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack role <span class="built_ins">add</span> --project demo --<span class="built_ins">user</span> demo <span class="built_ins">user</span></span><br></pre></td></tr></table></figure></p>
<h1 id="Verify_operation">Verify operation</h1><p>Verify operation of the Identity service before installing other services.</p>
<p>For security reasons, disable the temporary authentication token mechanism:</p>
<p>Edit the /usr/share/keystone/keystone-dist-paste.ini file and remove admin_token_auth from the [pipeline:public_api], [pipeline:admin_api], and [pipeline:api_v3] sections.</p>
<p>Unset the temporary OS_TOKEN and OS_URL environment variables:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">unset</span> OS_TOKEN OS_URL</span><br></pre></td></tr></table></figure>
<p>As the admin user, request an authentication token from the Identity version 2.0 API:</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">openstack</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">url</span> <span class="comment">http://controller:35357</span> <span class="comment">\</span></span><br><span class="line">  <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">project</span><span class="literal">-</span><span class="comment">name</span> <span class="comment">admin</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">username</span> <span class="comment">admin</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">type</span> <span class="comment">password</span> <span class="comment">\</span></span><br><span class="line">  <span class="comment">token</span> <span class="comment">issue</span></span><br></pre></td></tr></table></figure>
<p>The Identity version 3 API adds support for domains that contain projects and users. Projects and users can use the same names in different domains. Therefore, in order to use the version 3 API, requests must also explicitly contain at least the default domain or use IDs. For simplicity, this guide explicitly uses the default domain so examples can use names instead of IDs.</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">openstack</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">url</span> <span class="comment">http://controller:35357</span> <span class="comment">\</span></span><br><span class="line">  <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">project</span><span class="literal">-</span><span class="comment">domain</span><span class="literal">-</span><span class="comment">id</span> <span class="comment">default</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">user</span><span class="literal">-</span><span class="comment">domain</span><span class="literal">-</span><span class="comment">id</span> <span class="comment">default</span> <span class="comment">\</span></span><br><span class="line">  <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">project</span><span class="literal">-</span><span class="comment">name</span> <span class="comment">admin</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">username</span> <span class="comment">admin</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">type</span> <span class="comment">password</span> <span class="comment">\</span></span><br><span class="line">  <span class="comment">token</span> <span class="comment">issue</span></span><br></pre></td></tr></table></figure>
<p>As the admin user, list projects to verify that the admin user can execute admin-only CLI commands and that the Identity service contains the projects that you created in the section called “Create projects, users, and roles”:</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack <span class="comment">--os-auth-url http://controller:35357 \</span></span><br><span class="line">  <span class="comment">--os-project-name admin --os-username admin --os-auth-type password \</span></span><br><span class="line">  project <span class="type">list</span></span><br></pre></td></tr></table></figure>
<p>As the admin user, list users to verify that the Identity service contains the users that you created in the section called “Create projects, users, and roles”:</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack <span class="comment">--os-auth-url http://controller:35357 \</span></span><br><span class="line">  <span class="comment">--os-project-name admin --os-username admin --os-auth-type password \</span></span><br><span class="line">  user <span class="type">list</span></span><br></pre></td></tr></table></figure>
<p>As the admin user, list roles to verify that the Identity service contains the role that you created in the section called “Create projects, users, and roles”:</p>
<figure class="highlight applescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line">openstack <span class="comment">--os-auth-url http://controller:35357 \</span></span><br><span class="line">  <span class="comment">--os-project-name admin --os-username admin --os-auth-type password \</span></span><br><span class="line">  role <span class="type">list</span></span><br></pre></td></tr></table></figure>
<p>As the demo user, request an authentication token from the Identity version 3 API:</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">openstack</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">url</span> <span class="comment">http://controller:5000</span> <span class="comment">\</span></span><br><span class="line">  <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">project</span><span class="literal">-</span><span class="comment">domain</span><span class="literal">-</span><span class="comment">id</span> <span class="comment">default</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">user</span><span class="literal">-</span><span class="comment">domain</span><span class="literal">-</span><span class="comment">id</span> <span class="comment">default</span> <span class="comment">\</span></span><br><span class="line">  <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">project</span><span class="literal">-</span><span class="comment">name</span> <span class="comment">demo</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">username</span> <span class="comment">demo</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">type</span> <span class="comment">password</span> <span class="comment">\</span></span><br><span class="line">  <span class="comment">token</span> <span class="comment">issue</span></span><br></pre></td></tr></table></figure>
<p>This command uses the password for the demo user and API port 5000 which only allows regular (non-admin) access to the Identity service API.</p>
<p>As the demo user, attempt to list users to verify that it cannot execute admin-only CLI commands:</p>
<figure class="highlight brainfuck"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">openstack</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">url</span> <span class="comment">http://controller:5000</span> <span class="comment">\</span></span><br><span class="line">  <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">project</span><span class="literal">-</span><span class="comment">domain</span><span class="literal">-</span><span class="comment">id</span> <span class="comment">default</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">user</span><span class="literal">-</span><span class="comment">domain</span><span class="literal">-</span><span class="comment">id</span> <span class="comment">default</span> <span class="comment">\</span></span><br><span class="line">  <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">project</span><span class="literal">-</span><span class="comment">name</span> <span class="comment">demo</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">username</span> <span class="comment">demo</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">os</span><span class="literal">-</span><span class="comment">auth</span><span class="literal">-</span><span class="comment">type</span> <span class="comment">password</span> <span class="comment">\</span></span><br><span class="line">  <span class="comment">user</span> <span class="comment">list</span></span><br></pre></td></tr></table></figure>
<p>ERROR: openstack You are not authorized to perform the requested action, admin_required. (HTTP 403)</p>
<h1 id="Create_OpenStack_client_environment_scripts">Create OpenStack client environment scripts</h1><p>The previous section used a combination of environment variables and command options to interact with the Identity service via the openstack client. To increase efficiency of client operations, OpenStack supports simple client environment scripts also known as OpenRC files. These scripts typically contain common options for all clients, but also support unique options. For more information, see the OpenStack User Guide.</p>
<p>编辑 admin-openrc.sh 文件:<br><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">#</span></span><br><span class="line">echo <span class="string">"export OS_PROJECT_DOMAIN_ID=default</span></span><br><span class="line">export OS_USER_DOMAIN_ID=default</span><br><span class="line">export OS_PROJECT_NAME=admin</span><br><span class="line">export OS_TENANT_NAME=admin</span><br><span class="line">export OS_USERNAME=admin</span><br><span class="line">export OS_PASSWORD=admin</span><br><span class="line">export OS_AUTH_URL=http:<span class="comment">//controller:35357/v3" &gt;admin-openrc.sh</span></span><br></pre></td></tr></table></figure></p>
<p>编辑demo-openrc.sh文件：<br><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="preprocessor">#</span></span><br><span class="line">echo <span class="string">"export OS_PROJECT_DOMAIN_ID=default</span></span><br><span class="line">export OS_USER_DOMAIN_ID=default</span><br><span class="line">export OS_PROJECT_NAME=demo</span><br><span class="line">export OS_TENANT_NAME=demo</span><br><span class="line">export OS_USERNAME=demo</span><br><span class="line">export OS_PASSWORD=demo</span><br><span class="line">export OS_AUTH_URL=http:<span class="comment">//controller:5000/v3" &gt;demo-openrc.sh</span></span><br></pre></td></tr></table></figure></p>
<p>加载 client environment scripts<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="built_in">source</span> admin-openrc.sh</span><br><span class="line">openstack token issue</span><br></pre></td></tr></table></figure></p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/keystone/" rel="tag">#keystone</a>
          
            <a href="/tags/openstack/" rel="tag">#openstack</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/10/26/openstack-image-service/" rel="prev">openstack之kilo安装 镜像服务</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/10/24/openstack-Basic-environment/" rel="next">openstack之kilo安装 基础环境</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2015/10/25/openstack-Identity-service/"
                   data-title="openstack之kilo安装 认证服务" data-url="zhugaoxiao.github.io/2015/10/25/openstack-Identity-service/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://avatars2.githubusercontent.com/u/7880839?v=3&s=460" alt="zhugaoxiao" itemprop="image"/>
          <p class="site-author-name" itemprop="name">zhugaoxiao</p>
        </div>
        <p class="site-description motion-element" itemprop="description">大自然的搬运工</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">49</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">45</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhugaoxiao" target="_blank">github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/unodba" target="_blank">twitter</a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Install_and_configure"><span class="nav-number">1.</span> <span class="nav-text">Install and configure</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create_the_service_entity_and_API_endpoint"><span class="nav-number">2.</span> <span class="nav-text">Create the service entity and API endpoint</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create_projects,_users,_and_roles"><span class="nav-number">3.</span> <span class="nav-text">Create projects, users, and roles</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Verify_operation"><span class="nav-number">4.</span> <span class="nav-text">Verify operation</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Create_OpenStack_client_environment_scripts"><span class="nav-number">5.</span> <span class="nav-text">Create OpenStack client environment scripts</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhugaoxiao</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

本站总访问量 <span id="busuanzi_value_site_pv"></span> &nbsp&nbsp&nbsp
您是第<span id="busuanzi_value_site_uv"></span>个来到的小伙伴


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"zhugaoxiao"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
